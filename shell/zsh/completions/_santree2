#compdef santree2 st2
# -----------------------------------------------------------------------------
# Santree v2 Zsh Completion
# Git worktree manager - React/Ink/TypeScript version
# -----------------------------------------------------------------------------

__santree2_get_worktree_branches() {
    local -a branches
    branches=(${(f)"$(git worktree list --porcelain 2>/dev/null | grep '^branch ' | sed 's/branch refs\/heads\///')"})
    _describe -t branches 'worktree branches' branches
}

__santree2_get_all_branches() {
    local -a branches
    branches=(${(f)"$(git branch -a 2>/dev/null | sed 's/^[* ] //' | sed 's/remotes\/origin\///' | sort -u)"})
    _describe -t branches 'git branches' branches
}

__santree2_commands() {
    local -a commands
    commands=(
        'list:List all worktrees with status information'
        'create:Create a new worktree from a branch'
        'switch:Switch to another worktree'
        'remove:Remove a worktree and its branch'
        'work:Launch Claude to work on current ticket'
        'setup:Run init script in current worktree'
        'commit:Interactive commit with ticket ID'
        'pr:Create GitHub PR with Linear integration'
        'sync:Sync worktree with base branch'
        'clean:Remove worktrees with merged/closed PRs'
    )
    _describe -t commands 'santree2 commands' commands
}

__santree2_list() {
    # list has no arguments or options
    return 0
}

__santree2_create() {
    _arguments \
        '1:branch name:' \
        '--base[Base branch to create from]:base branch:__santree2_get_all_branches' \
        '--work[Launch Claude after creating]' \
        '--plan[With --work, only plan]' \
        '--no-pull[Skip pulling latest changes]'
}

__santree2_switch() {
    _arguments \
        '1:branch:__santree2_get_worktree_branches'
}

__santree2_remove() {
    _arguments \
        '1:branch:__santree2_get_worktree_branches' \
        '--force[Force removal even with uncommitted changes]'
}

__santree2_work() {
    _arguments \
        '--plan[Only create implementation plan]' \
        '--review[Review changes against ticket requirements]' \
        '--fix-pr[Fetch PR comments and fix them]'
}

__santree2_setup() {
    # setup has no arguments or options
    return 0
}

__santree2_commit() {
    # commit is interactive, no arguments
    return 0
}

__santree2_pr() {
    _arguments \
        '--draft[Create as draft PR]'
}

__santree2_sync() {
    _arguments \
        '--merge[Use merge instead of rebase]'
}

__santree2_clean() {
    _arguments \
        '--dry-run[Show what would be removed without removing]' \
        '--force[Skip confirmation prompt]'
}

_santree2() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1: :->command' \
        '*:: :->args'

    case $state in
        command)
            __santree2_commands
            ;;
        args)
            case $line[1] in
                list)
                    __santree2_list
                    ;;
                create)
                    __santree2_create
                    ;;
                switch|sw)
                    __santree2_switch
                    ;;
                remove|rm)
                    __santree2_remove
                    ;;
                work|w)
                    __santree2_work
                    ;;
                setup)
                    __santree2_setup
                    ;;
                commit)
                    __santree2_commit
                    ;;
                pr)
                    __santree2_pr
                    ;;
                sync)
                    __santree2_sync
                    ;;
                clean)
                    __santree2_clean
                    ;;
            esac
            ;;
    esac
}

_santree2 "$@"
