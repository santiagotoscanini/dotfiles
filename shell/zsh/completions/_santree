#compdef santree st
# -----------------------------------------------------------------------------
# Santree Zsh Completion
# Git worktree manager - React/Ink/TypeScript CLI
# -----------------------------------------------------------------------------

__santree_get_worktree_branches() {
    local -a branches
    branches=(${(f)"$(git worktree list --porcelain 2>/dev/null | grep '^branch ' | sed 's/branch refs\/heads\///')"})
    _describe -t branches 'worktree branches' branches
}

__santree_get_all_branches() {
    local -a branches
    branches=(${(f)"$(git branch -a 2>/dev/null | sed 's/^[* ] //' | sed 's/remotes\/origin\///' | sort -u)"})
    _describe -t branches 'git branches' branches
}

__santree_commands() {
    local -a commands
    commands=(
        'list:List all worktrees with status information'
        'create:Create a new worktree from a branch'
        'switch:Switch to another worktree'
        'remove:Remove a worktree and its branch'
        'work:Launch Claude to work on current ticket'
        'setup:Run init script in current worktree'
        'sync:Sync worktree with base branch'
        'clean:Remove worktrees with merged/closed PRs'
    )
    _describe -t commands 'santree commands' commands
}

__santree_list() {
    return 0
}

__santree_create() {
    _arguments \
        '1:branch name:' \
        '--base[Base branch to create from]:base branch:__santree_get_all_branches' \
        '--work[Launch Claude after creating]' \
        '--plan[With --work, only plan]' \
        '--no-pull[Skip pulling latest changes]'
}

__santree_switch() {
    _arguments \
        '1:branch:__santree_get_worktree_branches'
}

__santree_remove() {
    _arguments \
        '1:branch:__santree_get_worktree_branches' \
        '--force[Force removal even with uncommitted changes]'
}

__santree_work() {
    _arguments \
        '--plan[Only create implementation plan]' \
        '--review[Review changes against ticket requirements]' \
        '--fix-pr[Fetch PR comments and fix them]'
}

__santree_setup() {
    return 0
}

__santree_sync() {
    _arguments \
        '--rebase[Use rebase instead of merge]'
}

__santree_clean() {
    _arguments \
        '--dry-run[Show what would be removed without removing]' \
        '--force[Skip confirmation prompt]'
}

_santree() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '1: :->command' \
        '*:: :->args'

    case $state in
        command)
            __santree_commands
            ;;
        args)
            case $line[1] in
                list)
                    __santree_list
                    ;;
                create)
                    __santree_create
                    ;;
                switch|sw)
                    __santree_switch
                    ;;
                remove|rm)
                    __santree_remove
                    ;;
                work|w)
                    __santree_work
                    ;;
                setup)
                    __santree_setup
                    ;;
                sync)
                    __santree_sync
                    ;;
                clean)
                    __santree_clean
                    ;;
            esac
            ;;
    esac
}

_santree "$@"
